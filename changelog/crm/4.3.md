# Changelog

The format is based on [Keep a Changelog](http://keepachangelog.com/) and this project adheres to [Semantic Versioning](http://semver.org/). Instead of change type headers, we use module names.

All unreleased changes to this project will be documented in this file. Older changelogs can be found in folder [changelogs]().

## [4.3.0] - 2025-09-22

### [AdminModule]

- Added submit button disabling when the form is submitted. remp/respekt#450

### [AppleAppstoreModule]

- Fixed crashing `/api/v2/apple-appstore/verify-purchase` call due to missing dependency. remp/dn-mofa#567

### [ApplicationModule]

- Fixed measurement recalculation type-related error. remp/crm#3517
- Added `DetailWidgetInterface` for widgets requiring user ID access. remp/crm#3500
- Added type annotations to `LazyWidgetManager` methods. remp/crm#3500

### [FamilyModule]

- Fixed `IsFamilySlaveCriteria` scenario criteria to check if its family slave through `family_requests` table, instead of `family_subscription_types`. remp/respekt#454
  - Slave subscriptions are not always paired in `family_subscription_types`.

### [InvoicesModule]

- **BREAKING**: Refactored `InvoiceSandbox` to use `FlySystem` instead of Nette `Filesystem`. remp/crm#1727
  - InvoiceSandbox is used for exports of invoices (see action https://crm.press/invoices/invoices-admin/).
  - Default folder for storing generated ZIP changed from `/tmp` to `%appDir%/../content/invoice-sandbox`. Move your old exports to this folder if you want to keep them visible from admin screen (https://crm.press/invoices/invoices-admin/).
  - If your config contains override of default folder, you need to change it from previous syntax:

    ```neon
    invoiceSandbox: Crm\InvoicesModule\Models\Sandbox\InvoiceSandbox('/custom/path/to/invoice-sandbox')
    ```

    to new syntax:

    ```neon
    invoiceSandboxAdapter: League\Flysystem\Local\LocalFilesystemAdapter(
        '/custom/path/to/invoice-sandbox',
        League\Flysystem\UnixVisibility\PortableVisibilityConverter(directoryPublic: 0755),
    )
    ```
- **BREAKING**: Changed required interface for data providers registered for `invoices.dataprovider.invoice_form` in `ChangeInvoiceFormFactory`. remp/crm#3395
  - Originally used `AddressFormDataProviderInterface` is now replaced with invoice-specific `InvoiceFormDataProviderInterface`.
  - If you register your own data providers for `invoices.dataprovider.invoice_form`, replace their implemented interface.
- Changed the validation process of VAT. remp/crm#3504
  - Added the possibility to register VAT validators for specific country by configuration method `setValidatorForCountry`.
  - Previous `EuVatValidator` will be used as second option.

### KikaModule

- Replaced SPS custom map implementation with SPS widget to select delivery point. remp/crm#3547

### [PaymentsModule]

- Fixed type-related issue when displaying history widget for price. remp/crm#3527
- Fixed missing param in `RecurrentPaymentCardExpiredCriteria`. remp/helpdesk#3783
  - Empty criterion validation was added by version [4.2](https://github.com/remp2020/crm-scenarios-module/releases/tag/4.2.0). Without this fix, scenarios containing this criterion cannot be saved.
  - Migration to fix existing scenarios is included.
- Added refund handling to the PayPal payment gateways. remp/crm#3523
- Added `PaymentFormGeneralSettingsDataProviderInterface` data provider interface. remp/respekt#437
  - Added `PaymentFormGeneralSettingsDataProviderInterface` data provider `provide` and `formSucceed` calls to `PaymentFormFactory`.
- Fixed possibly duplicated recurrent payment if it was confirmed multiple times. remp/respekt#452

### [PrintModule]

- Added address ID and user ID into log when `ExportEngine` encounters missing country. remp/respekt#436
- Added metadata column to address changes requests in `UserChangeAddressRequest` widget. remp/respekt#413

### [ProductsModule]

- Added `OrderStatusWidget` component to display order status information for payments. remp/crm#3365
  - To remove this feature, use `$widgetManager->removeWidget()` in your `*Module.php`:
    ```php
    $widgetManager->removeWidget(
        'admin.payment.status.bottom',
        \Crm\ProductsModule\Components\OrderStatusWidget\OrderStatusWidget::class,
    );
    ```
- Fixed type-related issue when displaying history widget for price. remp/crm#3527

### [SubscriptionsModule]

- Refactored `UserSubscriptionInfoWidget` to use `NowTrait` instead of mysql `NOW()` function. remp/helpdesk#3752
- Modified `SubscriptionTypesFormFactory` to allow customizing the subscription type items via data provider. remp/crm#3528
- Added option to hide specific content access from frontend. remp/crm#3545

### [UpgradesModule]

- **DEPRECATED**: Monthly fix option in upgrade modules will be removed in the future releases without a replacement.
  - The feature was not used widely and was not compatible with different month lenghts and trial subscriptions.
  - If you used this kind of upgrade, configure schemas against specific subscription types with the appropriate prices.
- Fixed possibly incorrectly displayed prices in Free/Paid recurrent upgraders if trial subscription type was used. remp/helpdesk#3817
- Added `getTrialSubscriptionType` method to `TrialUpgrade`. remp/crm#3487
- Fixed iframe layout issues when displaying multiple subscription upgrade options. remp/crm#3535

### [UsersModule]

- Added audit log for `user_groups` table. remp/helpdesk#3739
- Added audit log for `addresses_meta` table. remp/respekt#420
- Fixed possibly incomplete user identity after registration. remp/respekt#111
- Standardized widget `header()` methods. remp/crm#3500
  - Widgets using `$id` parameter implement `DetailWidgetInterface` with `string` return type
  - Removed unused `$id` parameters and redundant `WidgetInterface` implementations
- Added protection preventing editability of anonymized users. remp/crm#3363
- Added the name as separate form field of admin user's search form. remp/helpdesk#3730
  - Fixes also issue: search did not search in the fields `addresses.first_name` and `addresses.last_name`. This was regression caused by [version 4.1](https://github.com/remp2020/crm-users-module/releases/tag/4.1.0).
